# SkillBridge API

This directory contains all API client code, hooks, and types for communicating with the SkillBridge backend.

## ✅ Authentication

**All API requests automatically include the auth token** from storage (cookies on web, AsyncStorage on mobile).

### How it works:
1. When a user logs in, the token is stored via `AuthContext`
2. All API instances read the token from storage before each request
3. The token is automatically added to the `x-auth-token` header
4. No manual token management needed in your components!

## API Instances

Pre-configured API instances with automatic authentication:

```typescript
import { 
  authApi,      // Authentication endpoints
  chatApi,      // Chat and messaging
  calendarApi,  // Tutor calendar/availability
  lessonApi,    // Lesson booking
  studentApi,   // Student operations
  subjectApi,   // Subject/course management
  tutorApi,     // Tutor operations
  userApi       // User profile management
} from 'app/api'
```

## React Query Hooks

Ready-to-use hooks for all endpoints:

### Authentication
```typescript
import { useLogin, useRegister } from 'app/api'

const { mutate: login } = useLogin()
const { mutate: register } = useRegister()
```

### User Management
```typescript
import { useCurrentUser, useUser, useUpdateUser } from 'app/api'

const { data: currentUser } = useCurrentUser()
const { data: user } = useUser(userId)
const { mutate: updateUser } = useUpdateUser()
```

### Chat
```typescript
import { useFindChat, useChatMessages } from 'app/api'

const { data: chat } = useFindChat(studentId, tutorId)
const { data: messages } = useChatMessages(chatId)
// Messages auto-refresh every 5 seconds
```

### Subjects
```typescript
import { useSubjects, useCreateSubject } from 'app/api'

const { data: subjects } = useSubjects()
const { mutate: createSubject } = useCreateSubject()
```

### Tutors & Students
```typescript
import { useTutors, useTutorsBySubject, useStudents } from 'app/api'

const { data: tutors } = useTutors()
const { data: tutorsBySubject } = useTutorsBySubject(subjectId)
const { data: students } = useStudents()
```

### Calendar (Tutor Availability)
```typescript
import { useTutorCalendar, useCreateCalendarSlot } from 'app/api'

const { data: calendar } = useTutorCalendar(tutorId)
const { mutate: createSlot } = useCreateCalendarSlot()
```

### Lessons
```typescript
import { useLessons, useBookLesson } from 'app/api'

const { data: lessons } = useLessons()
const { mutate: bookLesson } = useBookLesson()
```

## TypeScript Types

All backend types are available:

```typescript
import type {
  User,
  Subject,
  ChatResponse,
  ChatMessageResponse,
  CalendarSlot,
  Lesson,
  BookLesson,
  CreateSubject,
  CreateCalendarSlot,
  UpdateUser,
  // ... and many more
} from 'app/api'
```

## Example Usage

### Booking a Lesson
```typescript
import { useBookLesson } from 'app/api'
import type { BookLesson } from 'app/api'

function BookLessonButton({ slotId, tutorId }: { slotId: string; tutorId: string }) {
  const { mutate: bookLesson, isPending } = useBookLesson()

  const handleBook = () => {
    const booking: BookLesson = {
      calendarSlotId: slotId,
      tutorId: tutorId,
    }
    
    bookLesson(booking, {
      onSuccess: () => {
        console.log('Lesson booked successfully!')
      },
      onError: (error) => {
        console.error('Failed to book lesson:', error)
      },
    })
  }

  return (
    <Button onPress={handleBook} disabled={isPending}>
      {isPending ? 'Booking...' : 'Book Lesson'}
    </Button>
  )
}
```

### Chat Component
```typescript
import { useFindChat, useChatMessages } from 'app/api'

function ChatScreen({ studentId, tutorId }: { studentId: string; tutorId: string }) {
  const { data: chat } = useFindChat(studentId, tutorId)
  const { data: messages, isLoading } = useChatMessages(chat?.id || '', !!chat)

  if (isLoading) return <Text>Loading...</Text>

  return (
    <YStack>
      {messages?.map((msg) => (
        <Text key={msg.id}>{msg.content}</Text>
      ))}
    </YStack>
  )
}
```

## Files Structure

```
api/
├── api-config.ts          # Auth configuration
├── api-instances.ts       # Pre-configured API instances
├── client.ts              # Legacy openapi-fetch client
├── generated/             # Auto-generated by OpenAPI
│   ├── apis/             # API controller classes
│   ├── models/           # TypeScript types
│   └── runtime.ts        # OpenAPI runtime
├── hooks/                # React Query hooks
│   ├── use-auth.ts
│   ├── use-chat.ts
│   ├── use-user.ts
│   ├── use-subjects.ts
│   ├── use-tutors.ts
│   ├── use-calendar.ts
│   └── use-lessons.ts
└── types.ts              # OpenAPI TypeScript types
```

## Regenerating API

When the backend changes:

```bash
yarn generate-api
```

This will:
1. Fetch the latest OpenAPI spec from the backend
2. Generate TypeScript types
3. Generate API client classes
4. Fix any path issues automatically

**Note:** The hooks in `hooks/` are custom and won't be overwritten!








